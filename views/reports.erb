<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm mb-4">
        <div class="card-header navbar-custom text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Отчеты</h4>
            <a href="/" class="btn btn-sm btn-outline-light">
              <i class="bi bi-arrow-left me-1"></i>На главную
            </a>
          </div>
        </div>
      <!-- Добавим в начало после card-body -->
<div class="card-body">
  <h5 class="mb-4">Выберите период для отчета</h5>
  
  <div class="row mb-4">
    <div class="col-md-6">
      <label for="start-date" class="form-label">Начальная дата</label>
      <input type="text" class="form-control date-picker" id="start-date" placeholder="дд.мм.гггг">
    </div>
    <div class="col-md-6">
      <label for="end-date" class="form-label">Конечная дата</label>
      <input type="text" class="form-control date-picker" id="end-date" placeholder="дд.мм.гггг">
    </div>
  </div>
  
  <div class="d-flex justify-content-center mb-4">
    <button class="btn btn-custom" id="generateReport">
      <i class="bi bi-gear-wide-connected me-2"></i>Сформировать отчет
    </button>
  </div>
</div>

<!-- Заменим блок reportContent на -->
<div class="card shadow-sm d-none" id="reportContent">
<div class="card-header bg-light d-flex justify-content-between align-items-center">
  <h5 class="mb-0">Общая статистика <small id="reportPeriod" class="text-muted"></small></h5>
  <div>
    <button class="btn btn-sm btn-outline-secondary me-2" id="printReport">
      <i class="bi bi-printer me-1"></i>Печать
    </button>
<%#     <button class="btn btn-sm btn-success" id="exportExcel">
      <i class="bi bi-file-earmark-excel me-1"></i>Excel
    </button> %>
  </div>
</div>
  <div class="card-body">
    <!-- Статистика -->
    <div class="row mb-4" id="statsCards">
      <!-- Будет заполнено через JS -->
    </div>
    
    <!-- Таблица -->
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="reportTable">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Занято коек</th>
            <th>Процент занятости</th>
          </tr>
        </thead>
        <tbody>
          <!-- Будет заполнено через JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .stat-card {
    border-radius: 10px;
    padding: 1.5rem;
    color: white;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
  }
  
  .stat-card .value {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0.5rem 0;
  }
  
  .stat-card .label {
    font-size: 1rem;
    opacity: 0.9;
  }
  
  #reportTable th {
    background-color: var(--main-color);
    color: white;
  }
  
  .progress {
    height: 20px;
    border-radius: 10px;
  }
  
  .progress-bar {
    background-color: var(--main-color);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Инициализация datepicker
  flatpickr('.date-picker', {
    locale: "ru",
    dateFormat: "d.m.Y",
    allowInput: true,
    defaultDate: new Date()
  });
  
  // Обработчик генерации отчета
  document.getElementById('generateReport').addEventListener('click', function() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
      showAlert('Ошибка', 'Пожалуйста, укажите обе даты');
      return;
    }
    
    generateReport(startDate, endDate);
  });
  
  function generateReport(startDate, endDate) {
    const reportContent = document.getElementById('reportContent');
    const reportPeriod = document.getElementById('reportPeriod');
    const statsCards = document.getElementById('statsCards');
    const tableBody = document.querySelector('#reportTable tbody');
    
    // Показываем загрузку
    reportContent.classList.remove('d-none');
    reportPeriod.textContent = `за период с ${startDate} по ${endDate}`;
    statsCards.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border text-primary"></div></div>';
    tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-3"><div class="spinner-border text-primary"></div></td></tr>';
    
    // Запрашиваем данные с сервера
    fetch(`/reports/general_stats?start_date=${startDate}&end_date=${endDate}`)
      .then(response => response.json())
      .then(data => {
        // Обновляем статистику
        statsCards.innerHTML = `
          <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e);">
              <div class="label">Всего занято коек</div>
              <div class="value">${data.stats.total_occupied}</div>
              <div class="small">из ${(data.table_data.length * 18).toLocaleString('ru-RU')} возможных</div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #54c654, #7dd67d);">
              <div class="label">Свободно коек</div>
              <div class="value">${data.stats.total_free}</div>
              <div class="small">${(100 - data.stats.avg_occupancy).toFixed(1)}% от общего количества</div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #4e73df, #7a9df1);">
              <div class="label">Средняя занятость</div>
              <div class="value">${data.stats.avg_occupancy}%</div>
              <div class="progress mt-2">
                <div class="progress-bar" role="progressbar" style="width: ${data.stats.avg_occupancy}%" 
                  aria-valuenow="${data.stats.avg_occupancy}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
        `;
        
        // Заполняем таблицу
        tableBody.innerHTML = data.table_data.map(item => `
          <tr>
            <td>${item.date}</td>
            <td>${item.occupied}</td>
            <td>
              <div class="d-flex align-items-center">
                <div class="progress flex-grow-1" style="height: 10px;">
                  <div class="progress-bar" role="progressbar" style="width: ${item.percentage}%" 
                    aria-valuenow="${item.percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="ms-2">${item.percentage}%</small>
              </div>
            </td>
          </tr>
        `).join('');
        
        // Прокручиваем к отчету
        reportContent.scrollIntoView({ behavior: 'smooth' });
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('Ошибка', 'Не удалось загрузить данные отчета');
      });
  }
});
</script>
<script>
  // Обработчик печати
  document.getElementById('printReport').addEventListener('click', function() {
    const printContent = document.getElementById('reportContent').cloneNode(true);
    const printWindow = window.open('', '', 'width=800,height=600');
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Отчет по занятости коек</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          @media print {
            body { padding: 20px; }
            .stat-card { color: black !important; break-inside: avoid; }
            table { break-inside: avoid; }
            .no-print { display: none !important; }
          }
          .print-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
          }
        </style>
      </head>
      <body>
        <div class="print-header">
          <h3>Отчет по занятости коек</h3>
          <h5 id="printPeriod"></h5>
          <p>Сформировано: ${new Date().toLocaleDateString('ru-RU')}</p>
        </div>
        ${printContent.innerHTML}
      </body>
      </html>
    `);
    
    // Обновляем период в печатной версии
    printWindow.document.getElementById('printPeriod').textContent = 
      document.getElementById('reportPeriod').textContent;
    
    // Удаляем кнопки из печатной версии
    printWindow.document.querySelectorAll('.no-print').forEach(el => el.remove());
    
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  });
  
  // Обработчик экспорта в Excel
  document.getElementById('exportExcel').addEventListener('click', function() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
      showAlert('Ошибка', 'Пожалуйста, укажите период для экспорта');
      return;
    }
    
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Выгрузка...';
    btn.disabled = true;
    
    window.location.href = `/reports/export_excel?start_date=${startDate}&end_date=${endDate}`;
    
    setTimeout(() => {
      btn.innerHTML = originalHtml;
      btn.disabled = false;
    }, 2000);
  });
</script>